<% layout("/layouts/boilerplate") %>
<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const listing = <%- JSON.stringify(listing) %>;
  
  // Calculate average rating in EJS template context
  <% 
    let averageRating = 0;
    if (listing.reviews && listing.reviews.length > 0) {
      const sum = listing.reviews.reduce((acc, review) => acc + review.rating, 0);
      averageRating = sum / listing.reviews.length;
    }
  %>
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

<style>
  :root {
    --airbnb-pink: #FF385C;
    --airbnb-dark: #222222;
    --airbnb-light-gray: #ebebeb;
  }
  
  .listing-container {
    max-width: 1280px;
    margin: 0 auto;
    font-family: 'Circular', -apple-system, BlinkMacSystemFont, sans-serif;
  }
  
  .listing-header {
    border-bottom: 1px solid var(--airbnb-light-gray);
    padding-bottom: 24px;
  }
  
  .listing-gallery {
    height: 60vh;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 32px;
  }
  
  .listing-gallery img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  
  .listing-gallery:hover img {
    transform: scale(1.02);
  }
  
  .booking-card {
    position: sticky;
    top: 24px;
    border: 1px solid var(--airbnb-light-gray);
    border-radius: 16px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    padding: 24px;
  }
  
  .price-display {
    font-size: 22px;
    font-weight: 600;
    color: var(--airbnb-dark);
  }
  
  .booking-btn {
    background: var(--airbnb-pink);
    color: white;
    width: 100%;
    padding: 14px 24px;
    border-radius: 8px;
    font-weight: 600;
    border: none;
    transition: all 0.3s ease;
  }
  
  .booking-btn:hover {
    background: #E61E4D;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 56, 92, 0.3);
  }
  
  .amenities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
  }
  
  .amenity-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
  }
  
  .review-card {
    border-bottom: 1px solid var(--airbnb-light-gray);
    padding-bottom: 24px;
    margin-bottom: 24px;
  }
  
  .flatpickr-calendar {
    border-radius: 12px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    font-family: inherit;
  }
  
  .flatpickr-day.selected {
    background: var(--airbnb-pink);
    border-color: var(--airbnb-pink);
  }
  
  .flatpickr-day.today {
    border-color: var(--airbnb-pink);
  }
  
  .flatpickr-day:hover {
    background: #ffeef2;
  }
  
  @media (max-width: 768px) {
    .booking-card {
      margin-top: 24px;
      position: static;
    }
    
    .listing-gallery {
      height: 40vh;
    }
    
    .amenities-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<div class="listing-container">
  <div class="listing-header mt-4">
    <h1 class="fw-bold"><%= listing.title %></h1>
    <div class="d-flex align-items-center gap-3 mt-2">
      
      <span><i class="bi bi-geo-alt"></i> <%= listing.location %>, <%= listing.country %></span>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-lg-8 pe-lg-5">
      <div class="listing-gallery">
        <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="img-fluid">
      </div>

      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between border-bottom pb-4">
            <div>
              <h2 class="fw-bold">Entire <%= listing.type || 'place' %> hosted by <%= listing.owner.username %></h2>
              <p class="text-muted">
                <i class="bi bi-people"></i> <%= listing.guests || 2 %> guests · 
                <i class="bi bi-door-open"></i> <%= listing.bedrooms || 1 %> bedrooms · 
                <i class="bi bi-bed"></i> <%= listing.beds || 1 %> beds · 
                <i class="bi bi-bucket"></i> <%= listing.bathrooms || 1 %> baths
              </p>
            </div>
            
          </div>

          <div class="py-4 border-bottom">
            <h4 class="fw-bold mb-3">What this place offers</h4>
            <div class="amenities-grid">
              <% const amenities = listing.amenities || ['Wifi', 'TV', 'Air conditioning', 'Kitchen']; %>
              <% amenities.forEach(amenity => { %>
                <div class="amenity-item">
                  <i class="bi bi-<%= 
                    amenity === 'Wifi' ? 'wifi' :
                    amenity === 'TV' ? 'tv' :
                    amenity === 'Air conditioning' ? 'snow' :
                    amenity === 'Kitchen' ? 'cup-hot' : 'check-circle'
                  %> fs-5"></i>
                  <span><%= amenity %></span>
                </div>
              <% }); %>
            </div>
          </div>

          <div class="py-4 border-bottom">
            <h4 class="fw-bold mb-3">About this place</h4>
            <p class="lead"><%= listing.description %></p>
          </div>

          <div class="py-4" id="reviews">
            <div class="d-flex align-items-center gap-3 mb-4">
              <h4 class="fw-bold mb-0"><i class="bi bi-star-fill"></i> <%= averageRating.toFixed(1) %></h4>
              <% if(listing.reviews.length > 0) { %>
                <span>·</span>
                <a href="#reviews" class="text-dark"><%= listing.reviews.length %> reviews</a>
              <% } %>
            </div>

            <% if(currUser) { %>
              <div class="card border-0 shadow-sm p-4 mb-4">
                <h5>Leave a Review</h5>
                <form action="/listings/<%= listing.id %>/reviews" method="POST">
                  <div class="mb-3">
                    <label class="form-label fw-bold">Rating</label>
                    <fieldset class="starability-slot">
                      <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                      <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                      <label for="first-rate1" title="Terrible">1 star</label>
                      <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                      <label for="first-rate2" title="Not good">2 stars</label>
                      <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                      <label for="first-rate3" title="Average">3 stars</label>
                      <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                      <label for="first-rate4" title="Very good">4 stars</label>
                      <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                      <label for="first-rate5" title="Amazing">5 stars</label>
                    </fieldset>
                  </div>
                  <div class="mb-3">
                    <label for="comment" class="form-label fw-bold">Your Review</label>
                    <textarea name="review[comment]" id="comment" class="form-control" rows="4" 
                              placeholder="Share your experience..." required></textarea>
                  </div>
                  <button type="submit" class="btn btn-dark">Submit Review</button>
                </form>
              </div>
            <% } %>

            <% if(listing.reviews.length > 0) { %>
              <div class="row">
                <% for (review of listing.reviews) { %>
                  <div class="col-12 mb-4">
                    <div class="review-card">
                      <div class="d-flex align-items-center gap-3 mb-2">
                        <i class="fa-solid fa-circle-user"></i>
                        <div>
                          <h6 class="mb-0 fw-bold"><%= review.author.username %></h6>
                          <small class="text-muted">
                            <%= review.createdAt.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) %>
                          </small>
                        </div>
                      </div>
                      <div class="starability-result mb-2" data-rating="<%= review.rating %>"></div>
                      <p class="mb-3"><%= review.comment %></p>
                      <% if(currUser && review.author._id.equals(currUser._id)) { %>
                        <form action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE" method="POST">
                          <button class="btn btn-sm btn-outline-dark">
                            <i class="bi bi-trash"></i> Delete
                          </button>
                        </form>
                      <% } %>
                    </div>
                  </div>
                <% } %>
              </div>
            <% } else { %>
              <div class="text-center py-5 bg-light rounded-3">
                <i class="bi bi-chat-square-text fs-1 text-muted mb-3"></i>
                <h5>No reviews yet</h5>
                <p class="text-muted">Be the first to review this property!</p>
              </div>
            <% } %>
          </div>

          <div class="py-4">
            <h4 class="fw-bold mb-3"><i class="bi bi-geo-alt-fill"></i> Where you'll be</h4>
            <div id="map" style="height: 400px; border-radius: 16px; border: 1px solid #ebebeb;"></div>
            <p class="mt-3 fw-medium"><%= listing.location %>, <%= listing.country %></p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="booking-card">
        <div class="d-flex justify-content-between align-items-end mb-3">
          <div>
            <span class="price-display">₹<%= listing.price.toLocaleString("en-IN") %></span>
            <span class="per-night text-muted">/ night</span>
          </div>

        </div>

        <div class="mb-4">
          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label fw-bold">CHECK-IN</label>
              <input type="text" class="form-control datepicker" id="checkin" placeholder="Select date" readonly>
            </div>
            <div class="col-6">
              <label class="form-label fw-bold">CHECKOUT</label>
              <input type="text" class="form-control datepicker" id="checkout" placeholder="Select date" readonly>
            </div>
          </div>
          <label class="form-label fw-bold">GUESTS</label>
          <select class="form-select mb-4" id="guests-select">
            <option value="1">1 guest</option>
            <option value="2">2 guest</option>
            <option value="3">3 guest</option>
          </select>
        </div>

        <button class="booking-btn mb-3">
          <i class="bi bi-calendar-check"></i> Reserve
        </button>

        <p class="text-center text-muted mb-4">You won't be charged yet</p>

        <div class="mt-4">
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">₹<%= listing.price.toLocaleString("en-IN") %> x <span id="nights-count">1</span> nights</span>
            <span id="base-price">₹<%= listing.price.toLocaleString("en-IN") %></span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Cleaning fee</span>
            <span>₹500</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Service fee</span>
            <span>₹800</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between fw-bold fs-5 mt-3">
            <span>Total</span>
            <span id="total-price">₹<%= (listing.price + 500 + 800).toLocaleString("en-IN") %></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-5 border-top pt-5">
    <div class="col-md-8 offset-md-2">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="fw-bold">Hosted by <%= listing.owner.username %></h4>
          <% if(listing.owner.createdAt) { %>
            <p class="text-muted">
              <i class="bi bi-calendar"></i> Joined in <%= listing.owner.createdAt.toLocaleDateString('en-US', { year: 'numeric' }) %>
            </p>
          <% } %>
        </div>
       
      </div>
      
      <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
        <div class="d-flex gap-3 mt-4">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark px-4 py-2">
            <i class="bi bi-pencil-square me-2 "></i> Edit Listing
          </a>
          <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" >
            <button type="button" class="btn btn-outline-dark px-4 py-2 confirm-delete">
              <i class="bi bi-trash3 me-2 "></i> Delete Listing
            </button>
          </form>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="/js/map.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const checkinPicker = flatpickr("#checkin", {
      minDate: "today",
      dateFormat: "M j, Y",
      onChange: function(selectedDates) {
        if(selectedDates.length > 0) {
          const nextDay = new Date(selectedDates[0]);
          nextDay.setDate(nextDay.getDate() + 1);
          checkoutPicker.set("minDate", nextDay);
          
          if(checkoutPicker.selectedDates.length > 0 && 
             checkoutPicker.selectedDates[0] <= selectedDates[0]) {
            checkoutPicker.clear();
          }
          calculateTotal();
        }
      }
    });

    const checkoutPicker = flatpickr("#checkout", {
      minDate: new Date(today.getTime() + 86400000),
      dateFormat: "M j, Y",
      onChange: calculateTotal
    });

    const guestsSelect = document.getElementById('guests-select');
    guestsSelect.addEventListener('change', calculateTotal);

    function calculateTotal() {
      const pricePerNight = <%= listing.price %>;
      const cleaningFee = 500;
      const serviceFee = 800;
      let nights = 1;
      
      if(checkinPicker.selectedDates.length > 0 && checkoutPicker.selectedDates.length > 0) {
        const diffTime = Math.abs(checkoutPicker.selectedDates[0] - checkinPicker.selectedDates[0]);
        nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      }
      
      document.getElementById('nights-count').textContent = nights;
      const basePrice = pricePerNight * nights;
      document.getElementById('base-price').textContent = '₹' + basePrice.toLocaleString('en-IN');
      
      const total = basePrice + cleaningFee + serviceFee;
      document.getElementById('total-price').textContent = '₹' + total.toLocaleString('en-IN');
    }

    const deleteBtn = document.querySelector('.confirm-delete');
    if(deleteBtn) {
      deleteBtn.addEventListener('click', function(e) {
        if(confirm('Are you sure you want to delete this listing?')) {
          this.closest('form').submit();
        }
      });
    }
  });
</script>